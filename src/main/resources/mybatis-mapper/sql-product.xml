<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.example.anesi.mapper.ProductMapper">
	
	<!-- 상품데이터 가져오는 쿼리 -->
	<select id="selectProduct" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT P.*, C.CATEGORY_NAME, D.DISCOUNT_PRICE, i.*

		FROM t3_tbl_product AS P
		JOIN t3_tbl_product_category AS C ON P.CATEGORY_NO = C.CATEGORY_NO
		LEFT JOIN (
		    SELECT PRODUCT_NO, PRODUCT_PRICE * (100 - DISCOUNT) / 100 AS DISCOUNT_PRICE
		    FROM t3_tbl_product
		    WHERE DISCOUNT_YN = 'Y'
		) AS D ON P.PRODUCT_NO = D.PRODUCT_NO
		
		INNER JOIN t3_tbl_product_image i
			ON P.PRODUCT_NO = i.PRODUCT_NO
		WHERE  i.THUMBNAIL_YN ='Y' 
		
		    <if test="categoryNo != '' and categoryNo != null">
		       AND P.CATEGORY_NO LIKE CONCAT((#{categoryNo}/10), '%')
		    </if>
		
		<if test="categoryOrderBar!='' and categoryOrderBar !=null">
			<!-- 가격낮은순정렬-->
			<if test='categoryOrderBar=="LowestPrice"'>
				ORDER BY P.PRODUCT_PRICE ASC
			</if>
			<!-- 가격높은순정렬-->
			<if test='categoryOrderBar=="HighestPrice"'>
				ORDER BY P.PRODUCT_PRICE DESC
			</if>
			<!-- 최신순정렬-->
			<if test='categoryOrderBar=="NewArrival"'>
				ORDER BY P.CDATETIME DESC			
			</if>
		</if>
		
	</select>
	
	
	
	<select id="selectCategoryList" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE MOD(CATEGORY_NO, 10) = 0
	</select>
	<select id="cartProductList" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE MOD(CATEGORY_NO, 10) = 0
	</select>
	
	<select id="selectCategoryList2" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE CATEGORY_NO LIKE CONCAT(#{no}, '%') AND CATEGORY_NO NOT LIKE'%0'
	</select>
	<!-- 상품 상세 정보 -->
	<select id="selectProductList" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT * 
		FROM t3_tbl_product 
		WHERE PRODUCT_NO= #{productNo}
	</select>
	<!-- 상품 리뷰 평점 -->
	<select id="selectCsatAvg" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT AVG(CSAT) AS csatAvg , COUNT(*) AS csatCnt
		FROM t3_tbl_user_review 
		WHERE PRODUCT_NO = #{productNo}
	</select>
	<!-- 상품 옵션 정보 -->
	<select id="selectOption" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT o.OPTION_NAME, o.OPTION_PRICE ,o.OPTION_NO
		FROM t3_tbl_product p
		INNER JOIN t3_tbl_product_option o ON p.PRODUCT_NO = o.PRODUCT_NO		
		WHERE p.PRODUCT_NO = #{productNo}
	</select>
	<!-- 상품 썸네일 이미지 -->
	<select id="selectThumbnailImg" parameterType="hashmap" resultType="com.example.anesi.model.Scrapbook">
		SELECT *
		FROM t3_tbl_product_image
		WHERE PRODUCT_NO = #{productNo} AND THUMBNAIL_YN = 'Y'
	</select>
	<!-- 상품 컨텐츠 이미지 -->
	<select id="selectcontentImg" parameterType="hashmap" resultType="com.example.anesi.model.Scrapbook">
		SELECT *
		FROM t3_tbl_product_image
		WHERE PRODUCT_NO = #{productNo} AND THUMBNAIL_YN = 'N'
	</select>
	<!-- 상품 상세 이미지 -->
	<select id="selectcontentImg2" parameterType="hashmap" resultType="com.example.anesi.model.Scrapbook">
		SELECT *
		FROM t3_tbl_product_image
		WHERE PRODUCT_NO = #{productNo} AND THUMBNAIL_YN = 'D'
	</select> 
	<!-- 리뷰 -->
	<select id="selectReview" parameterType="hashmap" resultType="com.example.anesi.model.Review">
		SELECT u.NICK, r.CREATEDATE, r.CSAT , r.`HELP`,r.CONTENT, p.U_IMG_NAME, p.U_IMG_PATH, ri.R_IMG_NAME, ri.R_IMG_PATH 
		FROM t3_tbl_user_review r
		INNER JOIN t3_tbl_user u ON r.USER_NO = u.USER_NO
		LEFT JOIN t3_tbl_review_image ri ON ri.R_NO = r.R_NO
		LEFT JOIN t3_tbl_profile_image p ON p.USER_NO = u.USER_NO
		WHERE r.PRODUCT_NO = #{productNo}
		ORDER BY r.CREATEDATE desc
		LIMIT #{startNum}, #{lastNum}
	</select>
	<!-- 리뷰 페이지 카운트 --> 
	<select id="selectCnt" resultType="int">
		SELECT COUNT(*) FROM t3_tbl_user_review
	</select>
	<!-- 리뷰 별점 개수-->
	<select id="selectReviewCnt" parameterType="hashmap" resultType="com.example.anesi.model.Review">
		SELECT COUNT(*) AS csatCnt, csat
		FROM t3_tbl_user_review
		GROUP BY csat
		ORDER BY csat desc 
	</select>
	<!-- 장바구니 등록 -->
	<insert id="insertCartUser" parameterType="hashmap">
		INSERT INTO t3_tbl_user_cart 
		(USER_NO, PRODUCT_NO, CNT)
		VALUES (#{userNo}, #{productNo}, 0)
	</insert>
	<!-- 장바구니 리스트불러오기-->
	<select id="userCartList" parameterType="hashmap" resultType="com.example.anesi.model.Cart">
		SELECT *
		FROM t3_tbl_user_cart 
		WHERE USER_NO = #{userNo}
	</select>
	
	<!-- 장바구니 수량추가-->
	<update id="updateCartCnt" parameterType="hashmap" >
		UPDATE t3_tbl_user_cart
		SET 
			CNT = CNT+1
		WHERE USER_NO = #{userNo} AND PRODUCT_NO = #{productNo}
	</update>	
	
	<!-- 스크랩북 등록 -->
	<insert id="insertScrapbook" parameterType="hashmap">
		INSERT INTO t3_tbl_user_scrapbook 
		(USER_NO, PRODUCT_NO, CNT)
		
		<if test="userNo!='' and userNo !=null">
		VALUES (#{userNo}, #{productNo}, 1)
		</if>
	</insert>
		<select id="selectScrapbookList" parameterType="hashmap" resultType="com.example.anesi.model.Scrapbook">
		SELECT *
		FROM t3_tbl_user_scrapbook 
		WHERE USER_NO = #{userNo}
		
	</select>
	
	<!-- 스크랩북 삭제 -->
	<delete id="deleteScrapbook" parameterType="hashmap">
		DELETE FROM t3_tbl_user_scrapbook 
		WHERE USER_NO=#{userNo} AND PRODUCT_NO = #{productNo} AND CNT>=1
	</delete>

	<select id="selectCartList" parameterType="int" resultType="com.example.anesi.model.Product">
	    SELECT
	        product.PRODUCT_NO, product.PRODUCT_NAME, image.IMG_NAME, image.IMG_PATH, product.MANUFACTURER, product.COUNTRY, product.PRODUCT_PRICE,
	        user.USER_NO
	    FROM
	        t3_tbl_product product
	    INNER JOIN
	        t3_tbl_product_image image ON product.PRODUCT_NO = image.PRODUCT_NO
	    INNER JOIN 
	        t3_tbl_user_cart cart ON cart.PRODUCT_NO = product.PRODUCT_NO
	    INNER JOIN
	        t3_tbl_user user ON user.USER_NO = cart.USER_NO
	    WHERE
	        user.USER_NO = #{userNo} AND image.THUMBNAIL_YN = 'Y'
	</select>
	<insert id="insertPorduct" parameterType="hashmap">
		INSERT INTO t3_tbl_product (
		  PRODUCT_NAME,
		  PRODUCT_PRICE,
		  DISCOUNT,
		  DISCOUNT_YN,
		  CATEGORY_NO,
		  MANUFACTURER,
		  COUNTRY
		) VALUES (
		#{productName},
		#{productPrices},
		#{discount},
		#{discountYn},
		#{category},
		#{manufacturer},
		#{country}
		);
	</insert>
		
	 <select id="insertSelectPorduct" parameterType="hashmap" resultType="com.example.anesi.model.Product">
	 	SELECT *
	 	FROM t3_tbl_product
	 	WHERE CATEGORY_NO = #{category} AND PRODUCT_NAME = #{productName} AND MANUFACTURER = #{manufacturer} AND PRODUCT_PRICE = #{productPrices}
	 </select>
	
</mapper>

	
	
	
	
