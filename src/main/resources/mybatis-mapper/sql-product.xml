<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.example.anesi.mapper.ProductMapper">
	
	<!-- 상품데이터 가져오는 쿼리 -->
	<select id="selectProduct" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT P.*, C.CATEGORY_NAME, D.DISCOUNT_PRICE
		FROM t3_tbl_product AS P
		JOIN t3_tbl_product_category AS C ON P.CATEGORY_NO = C.CATEGORY_NO
		LEFT JOIN (
		    SELECT PRODUCT_NO, PRODUCT_PRICE * (100 - DISCOUNT) / 100 AS DISCOUNT_PRICE
		    FROM t3_tbl_product
		    WHERE DISCOUNT_YN = 'Y'
		) AS D ON P.PRODUCT_NO = D.PRODUCT_NO
		
		
		
	
		    WHERE 1=1
		    <if test="categoryNo != '' and categoryNo != null">
		       AND P.CATEGORY_NO LIKE CONCAT((#{categoryNo}/10), '%')
		    </if>
		
		   
	
	
		<if test="categoryOrderBar!='' and categoryOrderBar !=null">
			<!-- 가격낮은순정렬-->
			<if test='categoryOrderBar=="LowestPrice"'>
				ORDER BY P.PRODUCT_PRICE ASC
			</if>
			<!-- 가격높은순정렬-->
			<if test='categoryOrderBar=="HighestPrice"'>
				ORDER BY P.PRODUCT_PRICE DESC
			</if>
			<!-- 최신순정렬-->
			<if test='categoryOrderBar=="NewArrival"'>
				ORDER BY P.CDATETIME DESC			
			</if>
		</if>
		
	</select>
	
	
	
	<select id="selectCategoryList" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE MOD(CATEGORY_NO, 10) = 0
	</select>
	<select id="cartProductList" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE MOD(CATEGORY_NO, 10) = 0
	</select>
	
	<select id="selectCategoryList2" parameterType="hashmap" resultType="com.example.anesi.model.Category">
		SELECT *
		FROM t3_tbl_product_category
		WHERE CATEGORY_NO LIKE CONCAT(#{no}, '%') AND CATEGORY_NO NOT LIKE'%0'
	</select>
	<!-- 상품 상세 정보 -->
	<select id="selectProductList" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT * 
		FROM t3_tbl_product 
		WHERE PRODUCT_NO= #{productNo}
	</select>
	<!-- 상품 리뷰 평점 -->
	<select id="selectCsatAvg" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT AVG(r.CSAT) AS csatAvg , COUNT(*) AS csatCnt
		FROM t3_tbl_product p
		INNER JOIN t3_tbl_user_review r ON p.PRODUCT_NO = r.PRODUCT_NO
		WHERE p.PRODUCT_NO= #{productNo}
	</select>
	<!-- 상품 옵션 정보 -->
	<select id="selectOption" parameterType="hashmap" resultType="com.example.anesi.model.Product">
		SELECT o.OPTION_NAME, o.OPTION_PRICE ,o.OPTION_NO
		FROM t3_tbl_product p
		INNER JOIN t3_tbl_product_option o ON p.PRODUCT_NO = o.PRODUCT_NO		
		WHERE p.PRODUCT_NO = #{productNo}
	</select>
	
</mapper>

	
	
	
	
